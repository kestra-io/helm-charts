name: "Update Helm Chart Version"

on:
  workflow_dispatch:
    inputs:
      new_version:
        description: "New version to update (ex: v1.2.3)"
        required: false
        type: string
  repository_dispatch:
    types: [update-helm-chart-version]

permissions:
  actions: read
  contents: write
  pull-requests: write

env:
  CI_COMMIT_AUTHOR: bump-version-wf
  CI_COMMIT_EMAIL: actions@github.com
  HELM_BRANCH_MERGE: "feat-helm/update-to-"

  # Files
  KESTRA_CHART_FILE: charts/kestra/Chart.yaml
  KESTRA_VALUES_FILE: charts/kestra/values.yaml
  STARTER_CHART_FILE: charts/kestra-starter/Chart.yaml

  # Inputs
  INPUTS_NEW_VERSION: ${{ inputs.new_version }}
  CLIENT_PAYLOAD_NEW_VERSION: ${{ github.event.client_payload.new_version }}

jobs:
  update-helm-charts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout master branch
        uses: actions/checkout@v5
        with:
          ref: master

      - name: Read latest chart versions
        id: read-latest
        run: |
          set -euo pipefail

          KESTRA_LATEST_VERSION=$(yq eval '.version' "${KESTRA_CHART_FILE}")
          CURRENT_APP_VERSION=$(yq eval '.appVersion' "${KESTRA_CHART_FILE}")
          STARTER_LATEST_VERSION=$(yq eval '.version' "${STARTER_CHART_FILE}")

          echo "KESTRA_LATEST_VERSION=${KESTRA_LATEST_VERSION}" >> $GITHUB_ENV
          echo "CURRENT_APP_VERSION=${CURRENT_APP_VERSION}" >> $GITHUB_ENV
          echo "STARTER_LATEST_VERSION=${STARTER_LATEST_VERSION}" >> $GITHUB_ENV

          echo "Detected kestra chart version: ${KESTRA_LATEST_VERSION}"
          echo "Detected kestra app version: ${CURRENT_APP_VERSION}"
          echo "Detected starter chart version: ${STARTER_LATEST_VERSION}"

      - name: Resolve incoming version
        id: resolve-version
        run: |
          set -euo pipefail

          NEW_APP_VER="${CLIENT_PAYLOAD_NEW_VERSION:-${INPUTS_NEW_VERSION}}"

          if [ -z "${NEW_APP_VER}" ]; then
            echo "No new version provided — failing workflow."
            exit 1
          fi

          echo "NEW_APP_VER=${NEW_APP_VER}" >> $GITHUB_ENV
          echo "Incoming version: ${NEW_APP_VER}"

      - name: Validate appVersion format
        id: validate-format
        run: |
          set -euo pipefail

          if [[ ! "${NEW_APP_VER}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: appVersion '${NEW_APP_VER}' is invalid. Must be in format vX.Y.Z (e.g., v1.2.3)."
            exit 1
          fi

          echo "appVersion format valid: ${NEW_APP_VER}"

      - name: Skip if incoming version is not newer
        id: version-check
        run: |
          set -euo pipefail

          echo "Comparing current appVersion ${CURRENT_APP_VERSION} with incoming version ${NEW_APP_VER}"

          CUR="${CURRENT_APP_VERSION#v}"
          NEW="${NEW_APP_VER#v}"
          HIGHEST=$(printf '%s\n' "$CUR" "$NEW" | sort -V | tail -n1)

          if [ "$HIGHEST" != "$NEW" ]; then
            echo "Incoming version is not newer — skipping Helm chart bump."
            exit 1
          fi

          echo "New version is greater — continuing with Helm chart update."

      - name: Check if target image exists on Docker Hub
        if: false
        id: check_image
        run: |
          set -euo pipefail

          IMAGE_NAME="kestra/kestra"
          echo "Checking if image ${IMAGE_NAME}:${NEW_APP_VER} exists on Docker Hub..."
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://hub.docker.com/v2/repositories/${IMAGE_NAME}/tags/${NEW_APP_VER}/")

          if [ "$STATUS_CODE" -ne 200 ]; then
            echo "Docker image ${IMAGE_NAME}:${NEW_APP_VER} does not exist on Docker Hub."
            exit 1
          fi

          echo "Docker image ${IMAGE_NAME}:${NEW_APP_VER} exists on Docker Hub."

      - name: Compute next patch versions (kestra + starter)
        id: compute-next
        run: |
          set -euo pipefail

          # kestra
          IFS='.' read -r K_MAJ K_MIN K_PAT <<< "${KESTRA_LATEST_VERSION}"
          K_NEXT_PAT=$((K_PAT + 1))
          NEXT_KESTRA_CHART_VERSION="${K_MAJ}.${K_MIN}.${K_NEXT_PAT}"

          # kestra-starter
          IFS='.' read -r S_MAJ S_MIN S_PAT <<< "${STARTER_LATEST_VERSION}"
          S_NEXT_PAT=$((S_PAT + 1))
          NEXT_STARTER_CHART_VERSION="${S_MAJ}.${S_MIN}.${S_NEXT_PAT}"

          echo "NEXT_KESTRA_CHART_VERSION=${NEXT_KESTRA_CHART_VERSION}" >> $GITHUB_ENV
          echo "NEXT_STARTER_CHART_VERSION=${NEXT_STARTER_CHART_VERSION}" >> $GITHUB_ENV

          echo "Computed kestra chart version: ${KESTRA_LATEST_VERSION} -> ${NEXT_KESTRA_CHART_VERSION}"
          echo "Computed kestra-starter chart version: ${STARTER_LATEST_VERSION} -> ${NEXT_STARTER_CHART_VERSION}"

      - name: Update charts (kestra + kestra-starter)
        id: update-charts
        run: |
          set -euo pipefail

          git config user.name "${CI_COMMIT_AUTHOR}"
          git config user.email "${CI_COMMIT_EMAIL}"

          yq e -i ".appVersion = \"${NEW_APP_VER}\"" "${KESTRA_CHART_FILE}"
          yq e -i ".version = \"${NEXT_KESTRA_CHART_VERSION}\"" "${KESTRA_CHART_FILE}"

          # Ensure docker tag matches appVersion (common place: values.yaml image.tag)
          if yq e '.image.tag' "${KESTRA_VALUES_FILE}" >/dev/null 2>&1; then
            yq e -i ".image.tag = \"${NEW_APP_VER}\"" "${KESTRA_VALUES_FILE}"
          else
            echo "Warning: ${KESTRA_VALUES_FILE} has no .image.tag key; skipping image tag update."
          fi

          yq e -i ".version = \"${NEXT_STARTER_CHART_VERSION}\"" "${STARTER_CHART_FILE}"
          yq e -i ".appVersion = \"${NEW_APP_VER}\"" "${STARTER_CHART_FILE}"

          if yq e '.dependencies' "${STARTER_CHART_FILE}" >/dev/null 2>&1; then
            yq e -i '
              (.dependencies[] | select(.name == "kestra") | .version) = "'"${NEXT_KESTRA_CHART_VERSION}"'"
            ' "${STARTER_CHART_FILE}"
          else
            echo "Warning: No dependencies section found in ${STARTER_CHART_FILE}; cannot update kestra dependency."
            exit 1
          fi

          COMMIT_MSG="Helm: kestra ${KESTRA_LATEST_VERSION}->${NEXT_KESTRA_CHART_VERSION}, starter ${STARTER_LATEST_VERSION}->${NEXT_STARTER_CHART_VERSION}, appVersion ${NEW_APP_VER}"

          echo "COMPUTED_APP_VERSION=${NEW_APP_VER}" >> $GITHUB_ENV
          echo "COMMIT_MSG=${COMMIT_MSG}" >> $GITHUB_ENV

      - name: Regenerate Helm docs
        uses: losisin/helm-docs-github-action@v1
        with:
          git-push: false

      - name: Commit changes
        run: |
          set -euo pipefail
          git add \
            "${KESTRA_CHART_FILE}" \
            "${KESTRA_VALUES_FILE}" \
            "${STARTER_CHART_FILE}" \
            charts/kestra/README.md \
            charts/kestra-starter/README.md
          git commit -m "${COMMIT_MSG}" || echo "No changes to commit"

      - name: Create Pull Request
        if: ${{ env.NEXT_KESTRA_CHART_VERSION != '' && env.NEXT_STARTER_CHART_VERSION != '' }}
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.HELM_BRANCH_MERGE }}${{ env.COMPUTED_APP_VERSION }}
          delete-branch: true
          title: "Helm charts update: kestra ${{ env.KESTRA_LATEST_VERSION }} → ${{ env.NEXT_KESTRA_CHART_VERSION }} (starter ${{ env.STARTER_LATEST_VERSION }} → ${{ env.NEXT_STARTER_CHART_VERSION }})"
          body: |
            Helm charts update to new version:

            **Kestra chart (`charts/kestra`)**
            - Old version: **${{ env.KESTRA_LATEST_VERSION }}**
            - New version: **${{ env.NEXT_KESTRA_CHART_VERSION }}**
            - appVersion: **${{ env.COMPUTED_APP_VERSION }}**
            - image.tag: **${{ env.COMPUTED_APP_VERSION }}**

            **Kestra Starter chart (`charts/kestra-starter`)**
            - Old version: **${{ env.STARTER_LATEST_VERSION }}**
            - New version: **${{ env.NEXT_STARTER_CHART_VERSION }}**
            - appVersion: **${{ env.COMPUTED_APP_VERSION }}**
            - Dependency `kestra` version: **${{ env.NEXT_KESTRA_CHART_VERSION }}**

            Auto-generated by [GitHub Action run #${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          labels: |
            automated pr
