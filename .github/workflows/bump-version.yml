name: "Update Helm Chart Version"

on:
  workflow_dispatch:
    inputs:
      new_version:
        description: "New version to update (ex: v1.0.x)"
        required: false
        type: string
  repository_dispatch:
    types: [update-helm-chart-version]

permissions:
  actions: read
  contents: write
  pull-requests: write

env:
  CI_COMMIT_AUTHOR: bump-version-wf
  CI_COMMIT_EMAIL: actions@github.com
  HELM_BRANCH_MERGE: "feat-helm/update-to-"
  CHART_FILE: charts/kestra/Chart.yaml
  INPUTS_NEW_VERSION: ${{ inputs.new_version }}
  CLIENT_PAYLOAD_NEW_VERSION: ${{ github.event.client_payload.new_version }}

jobs:
  update-helm-chart:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout master branch
        uses: actions/checkout@v5
        with:
          ref: master

      - name: Read latest chart version
        id: read-latest
        run: |
          LATEST_VERSION=$(yq eval '.version' "${CHART_FILE}")
          CURRENT_APP_VERSION=$(yq eval '.appVersion' "${CHART_FILE}")
          echo "LATEST_VERSION=${LATEST_VERSION}" >> $GITHUB_ENV
          echo "CURRENT_APP_VERSION=${CURRENT_APP_VERSION}" >> $GITHUB_ENV
          echo "Detected chart version: ${LATEST_VERSION}"
          echo "Detected app version: ${CURRENT_APP_VERSION}"

      - name: Skip if incoming version is not newer
        id: version-check
        run: |
          NEW_APP_VER="${CLIENT_PAYLOAD_NEW_VERSION:-${INPUTS_NEW_VERSION}}"

          if [ -z "${NEW_APP_VER}" ]; then
            echo "No new version provided — skipping workflow."
            exit 1
          fi

          echo "Comparing current appVersion ${CURRENT_APP_VERSION} with incoming version ${NEW_APP_VER}"

          CUR="${CURRENT_APP_VERSION#v}"
          NEW="${NEW_APP_VER#v}"
          HIGHEST=$(printf '%s\n' "$CUR" "$NEW" | sort -V | tail -n1)

          if [ "$HIGHEST" != "$NEW" ]; then
            echo "Incoming version is not newer — skipping Helm chart bump."
            exit 1
          else
            echo "New version is greater — continuing with Helm chart update."
          fi

      - name: Check if target image exists on Docker Hub
        id: check_image
        run: |
          NEW_APP_VER="${CLIENT_PAYLOAD_NEW_VERSION:-${INPUTS_NEW_VERSION}}"
          IMAGE_NAME="kestra/kestra"
          echo "Checking if image ${IMAGE_NAME}:${NEW_APP_VER} exists on Docker Hub..."
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://hub.docker.com/v2/repositories/${IMAGE_NAME}/tags/${NEW_APP_VER}/")
          if [ "$STATUS_CODE" -ne 200 ]; then
            echo "Docker image ${IMAGE_NAME}:${NEW_APP_VER} does not exist on Docker Hub."
            exit 1
          else
            echo "Docker image ${IMAGE_NAME}:${NEW_APP_VER} exists on Docker Hub."
          fi

      - name: Compute next patch version
        id: compute-next
        run: |
          IFS='.' read -r MAJOR MINOR PATCH <<< "${LATEST_VERSION}"
          NEXT_PATCH=$((PATCH + 1))
          NEXT_CHART_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}"
          echo "NEXT_CHART_VERSION=${NEXT_CHART_VERSION}" >> $GITHUB_ENV
          echo "Computed next chart version: ${LATEST_VERSION} -> ${NEXT_CHART_VERSION}"

      - name: Update Chart.yaml
        id: update-chart
        run: |
          set -e
          git config user.name "${CI_COMMIT_AUTHOR}"
          git config user.email "${CI_COMMIT_EMAIL}"

          NEXT_CHART="${NEXT_CHART_VERSION}"

          # Case A: repository_dispatch with app tag
          if [ -n "${CLIENT_PAYLOAD_NEW_VERSION:-}" ]; then
            APP_VER="${CLIENT_PAYLOAD_NEW_VERSION}"
            echo "Repository dispatch detected -> appVersion=${APP_VER}"
            yq e -i ".appVersion = \"${APP_VER}\"" "${CHART_FILE}"
            yq e -i ".version = \"${NEXT_CHART}\"" "${CHART_FILE}"
            COMMIT_MSG="Update chart version ${LATEST_VERSION} -> ${NEXT_CHART} and appVersion -> ${APP_VER}"

          # Case B: manual app bump with explicit new_version
          elif [ -n "${INPUTS_NEW_VERSION:-}" ]; then
            APP_VER="${INPUTS_NEW_VERSION}"
            echo "Manual app bump -> appVersion=${APP_VER}"
            yq e -i ".appVersion = \"${APP_VER}\"" "${CHART_FILE}"
            yq e -i ".version = \"${NEXT_CHART}\"" "${CHART_FILE}"
            COMMIT_MSG="Update chart version ${LATEST_VERSION} -> ${NEXT_CHART} and appVersion -> ${APP_VER}"

          else
            echo "No version inputs provided -> nothing to do."
            exit 1
          fi

          echo "NEXT_CHART_VERSION=${NEXT_CHART}" >> $GITHUB_ENV
          echo "COMPUTED_APP_VERSION=${APP_VER}" >> $GITHUB_ENV
          echo "COMMIT_MSG=${COMMIT_MSG}" >> $GITHUB_ENV

      - name: Regenerate Helm docs
        uses: losisin/helm-docs-github-action@v1
        with:
          git-push: false

      - name: Commit changes
        run: |
          git add "${CHART_FILE}" charts/kestra/README.md
          git commit -m "${COMMIT_MSG}" || echo "No changes to commit"

      - name: Create Pull Request
        if: ${{ env.NEXT_CHART_VERSION != '' }}
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.HELM_BRANCH_MERGE }}${{ env.COMPUTED_APP_VERSION }}

          delete-branch: true
          title: "Helm chart update: ${{ env.LATEST_VERSION }} → ${{ env.NEXT_CHART_VERSION }}"
          body: |
            Helm Chart update to new version:
            - Chart file: `${{ env.CHART_FILE }}`
            - Old version: **${{ env.LATEST_VERSION }}**
            - New version: **${{ env.NEXT_CHART_VERSION }}**
            - appVersion: **${{ env.COMPUTED_APP_VERSION }}**
            - Auto-generated by [GitHub Action run #${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          labels: |
            automated pr
