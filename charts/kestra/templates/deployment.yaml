{{ $global := .Values }}
{{ $common := .Values.common }}
{{ $kestra := merge .Values.deployments .Values.workerGroups }}
{{- range $name, $content := $kestra }}
{{- if $content.enabled }}
---
{{- $type := "worker" }}
{{- $list := list "standalone" "webserver" "executor" "indexer" "scheduler" }}
{{- range $i, $val := $list }}
{{- if eq $val $name }}
{{- $type = $name }}
{{- end }}
{{- end }}
{{- $dind := false }}
{{- if and ($global.dind.enabled) (eq $type "worker") }}
{{- $dind = true }}
{{- end }}
{{- if and ($global.dind.enabled) (eq $type "standalone") }}
{{- $dind = true }}
{{- end }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "{{ include "kestra.fullname" $ }}-{{ $name }}"
  labels:
    {{- include "kestra.labels" $ | nindent 4 }}
    app.kubernetes.io/component: {{ $type }}
    {{- with $common.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    {{- with $content.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
    {{- with $common.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    {{- with $content.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  replicas: {{ default $common.replicas $content.replicas }}
  revisionHistoryLimit: {{ default $common.revisionHistoryLimit $content.revisionHistoryLimit }}
  selector:
    matchLabels:
      {{- include "kestra.selectorLabels" $ | nindent 6 }}
      app.kubernetes.io/component: {{ $type }}
  {{- with (default $common.strategy $content.strategy) }}
  strategy:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  template:
    metadata:
      labels:
        {{- include "kestra.selectorLabels" $ | nindent 8 }}
        app.kubernetes.io/component: {{ $type }}
        {{- with $common.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- with $content.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      annotations:
        {{- with $common.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- with $content.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      serviceAccountName: {{ include "kestra.serviceAccountName" $ }}
      {{- with (default $common.priorityClassName $content.priorityClassName) }}
      priorityClassName: {{ . }}
      {{- end }}
      {{- if $global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml $global.imagePullSecrets | nindent 8 }}
      {{- end }}
      terminationGracePeriodSeconds: {{ default $common.terminationGracePeriodSeconds $content.terminationGracePeriodSeconds }}
      {{- with (default $common.podSecurityContext $content.podSecurityContext) }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if (or $common.nodeSelector $content.nodeSelector) }}
      nodeSelector:
        {{- with $common.nodeSelector }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- with $content.nodeSelector }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- end }}
      {{- if (or $common.affinity $content.affinity) }}
      affinity:
        {{- with $common.affinity }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- with $content.affinity }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- end }}
      {{- if (or $common.tolerations $content.tolerations) }}
      tolerations:
        {{- with $common.tolerations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- with $content.tolerations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- end }}
      {{- if (or $common.initContainers $content.initContainers) }}
      initContainers:
        {{- with $common.initContainers }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- with $content.initContainers }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- end }}
      containers:
        - name: kestra-{{ $type }}
          image: "{{ $global.image.repository }}:{{ default $.Chart.AppVersion $global.image.tag }}"
          imagePullPolicy: {{ $global.image.pullPolicy }}
          {{- with (default $common.securityContext $content.securityContext) }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          command:
            - "sh"
            - "-c"
            - | 
                exec /app/kestra server {{ $type }} \
                {{- if $content.workerThreads }}
                {{- if eq $type "standalone" }}
                --worker-thread={{ $content.workerThreads }} \
                {{- else }}
                --thread={{ $content.workerThreads }} \
                {{- end }}
                {{- end }}
                {{- with $content.extraArgs }}
                {{- range $key, $value := $content.extraArgs }}
                {{- $value }} \
                {{- end }}
                {{- end }}
          {{- with (default $common.resources $content.resources) }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          env:
            - name: MICRONAUT_CONFIG_FILES
              value: {{ include "kestra.micronautConfigFiles" $ | quote }}
            {{- with $common.extraEnv }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
            {{- with $content.extraEnv }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          {{- if (or $common.extraEnvFrom $content.extraEnvFrom) }}
          envFrom:
            {{- with $common.extraEnvFrom }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
            {{- with $content.extraEnvFrom }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          {{- end }}
          {{- with (default $common.startupProbe $content.startupProbe) }}
          startupProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with (default $common.livenessProbe $content.livenessProbe) }}
          livenessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with (default $common.readinessProbe $content.readinessProbe) }}
          readinessProbe:
            {{- toYaml .| nindent 12 }}
          {{- end }}
          ports:
            {{- range $n, $p := $global.service.ports }}
            - name: {{ $n }}
              containerPort: {{ $p.containerPort }}
              protocol: {{ $p.protocol | default "TCP" }}
            {{- end }}
          volumeMounts:
            - name: {{ template "kestra.fullname" $ }}-config
              mountPath: /app/_default.yml
              subPath: _default.yml
            {{- range $global.configurations.configmaps }}
            {{- $vname := printf "%s-%s" .name .key | replace "." "-" | kebabcase }}
            - name: {{ $vname }}
              mountPath: /app/{{ .key }}
              subPath: {{ .key }}
            {{- end }}
            {{- range $global.configurations.secrets }}
            {{- $vname := printf "%s-%s" .name .key | replace "." "-" | kebabcase }}
            - name: {{ $vname }}
              mountPath: /app/{{ .key }}
              subPath: {{ .key }}
            {{- end }}
            {{- with $common.extraVolumeMounts }}
              {{- toYaml . | nindent 12 }}
            {{- end }}
            {{- with $content.extraVolumeMounts }}
              {{- toYaml . | nindent 12 }}
            {{- end }}
            {{- if $dind }}
            - name: docker-dind-socket
              mountPath: /dind
            - name: docker-tmp
              mountPath: {{ $global.dind.tmpPath }}
            {{- end }}
        {{- if $dind }}
        {{- $dindMode := $global.dind.mode | default "rootless" }}
        {{- $dindConfig := index $global.dind.base $dindMode }}
        - name: {{ $.Chart.Name }}-{{ $type }}-docker-dind
          image: "{{ $dindConfig.image.repository }}:{{ $dindConfig.image.tag }}"
          imagePullPolicy: {{ $dindConfig.image.pullPolicy }}
          args:
            {{- toYaml $dindConfig.args | nindent 12 }}
          env:
            - name: DOCKER_HOST
              value: unix://{{ $global.dind.socketPath }}/docker.sock
            {{- if $global.dind.extraEnv }}
            {{ toYaml $global.dind.extraEnv | trim | nindent 12 }}
            {{- end }}
          securityContext:
            {{- if $dindConfig.securityContext }}
            {{- toYaml $dindConfig.securityContext | nindent 12 }}
            {{- end }}
          volumeMounts:
            {{- if $global.dind.extraVolumeMounts }}
            {{ toYaml $global.dind.extraVolumeMounts | trim | nindent 12 }}
            {{- end }}
            - name: docker-dind-socket
              mountPath: {{ $global.dind.socketPath }}
            - name: docker-tmp
              mountPath: {{ $global.dind.tmpPath }}
          resources:
            {{- toYaml $global.dind.resources | nindent 12 }}
        {{- end }}
        {{- range $common.extraContainers }}
        - {{- toYaml . | nindent 10 }}
        {{- end }}
        {{- range $content.extraContainers }}
        - {{- toYaml . | nindent 10 }}
        {{- end }}
      volumes:
        - name: {{ template "kestra.fullname" $ }}-config
          configMap:
            name: {{ template "kestra.fullname" $ }}-config
            items:
              - key: _default.yml
                path: _default.yml
        {{- range $global.configurations.configmaps }}
        {{- $vname := printf "%s-%s" .name .key | replace "." "-" | kebabcase }}
        - name: {{ $vname }}
          configMap:
            name: {{ .name }}
            items:
              - key: {{ .key }}
                path: {{ .key }}
        {{- end }}
        {{- range $global.configurations.secrets }}
        {{- $vname := printf "%s-%s" .name .key | replace "." "-" | kebabcase }}
        - name: {{ $vname }}
          secret:
            secretName: {{ .name }}
            defaultMode: 0444
            items:
              - key: {{ .key }}
                path: {{ .key }}
        {{- end }}
        {{- if $dind }}
        - name: docker-dind-socket
          emptyDir: {}
        - name: docker-tmp
          emptyDir: {}
        {{- end }}
        {{- with $common.extraVolumes }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- with $content.extraVolumes }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
{{- end }}
{{- end }}
